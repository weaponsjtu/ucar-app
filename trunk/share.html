<!DOCTYPE html> 
<html>
<head>
<meta name="viewport" content="initial-scale=1.0, user-scalable=no"/>
<meta charset="utf-8">
<title>分享页面</title>
<link href="jquery-mobile/jquery.mobile-1.2.0-alpha.1.css" rel="stylesheet" type="text/css"/>
<script src="jquery-mobile/jquery-1.7.2.js" type="text/javascript"></script>
<script src="jquery-mobile/jquery.mobile-1.2.0-alpha.1.js" type="text/javascript"></script>
<script src="cordova.js" type="text/javascript"></script>
<script type="text/javascript" src="http://qzonestyle.gtimg.cn/qzone/openapi/qc_loader.js" data-appid="100284268" data-redirecturi="http://ihavecar.sinaapp.com/qc_callback.html" charset="utf-8"></script>
<script type="text/javascript" src="jquery.raty.js"></script>

<script type="text/javascript" src="http://api.map.baidu.com/api?v=1.3"></script>
<script type="text/javascript" src="http://dev.baidu.com/wiki/static/map/API/examples/script/convertor.js"></script>
<script type="text/javascript" src="UcarV1.js"></script>

<script type="text/javascript">
$(function() {
	$('#star').raty({
		size:      24,
		starHalf:  'star-half-big.png',
		starOff:   'star-off-big.png',
		starOn:    'star-on-big.png'
	});
});

function back(){
	if (typeof(navigator) != 'undefined' && typeof(navigator.app) != 'undefined' && typeof(navigator.app.backHistory) == 'function') {
		navigator.app.backHistory();
	} else{
		history.back();
	}
}

$(document).ready(function(){
	$("#content").css("min-height", document.body.clientHeight - $("#content").offset().top);
	
	//getGPS();
	jQuery('body').live('swipeleft',function(event){
		back();
		//event.preventDefault();
	});
	jQuery('body').live('swiperight',function(event){
		window.history.forward();
		//event.preventDefault();
	});
});

$('.ui-btn-back').live('tap',function() {
	back();
	return false;
}).live('click',function() {
	back();
	return false;
});
</script>

<style type="text/css">
#sina {
	background: url('img/ucar_icon.gif') no-repeat;
	background-position: 0 0;
	width: 16px;
	height: 16px;
}

</style>
</head>

<body>
<div data-role="page">

 <div data-role="header" data-theme="b">
   <a href="#" class="ui-btn-back">返回</a>
   <h1><a href="#" data-role="button">点评与分享</a></h1>
   <a input id="submit" onClick="share()">发送</a>
 </div>
 
 <div data-role="content" id="content">
 <form action="" method="post">	
 	<div style="text-align: center" >
 		 <span  style="border-bottom: solid gray 1px" id="star"></span>
 	</div>
    
  <label for="textarea-a">发表评论: <span id="counter" style="float:right;">140字</span></label>
	<textarea name="textarea" id="textarea-a" autofocus onkeydown='countChar("textarea-a","counter");' onkeyup='countChar("textarea-a","counter");'></textarea>
    
  <div><span style="float:right;">我要分享到&nbsp;&nbsp;<img id="sina"></img></span></div>
 </form>
 </div>


<script type="text/javascript">
var d = new Date()
var now=d.getTime()/1000;
var url=window.location.href;
var arg1=url.split("=");
var arg2=arg1[1].split("&");
var type=arg2[0];
var arg3=arg1[2].split("&");
var shopid=arg3[0];
var shopname=decodeURI(arg1[3]);

var star=new Array(" ","★","★★","★★★","★★★★","★★★★★");

checklogin();

function countChar(textareaName,spanName)
{
	document.getElementById(spanName).innerHTML = 140 - document.getElementById(textareaName).value.length;
}


function share() {
	document.addEventListener("deviceready", onDeviceReady, false);
    // PhoneGap is ready
    function onDeviceReady() {
        window.requestFileSystem(LocalFileSystem.PERSISTENT, 0, gotFS, fail);
    }

    function gotFS(fileSystem) {
        fileSystem.root.getFile("ucar/DataFile.txt", {create: true}, gotFileEntry, fail);
    }

    function gotFileEntry(fileEntry) {
        fileEntry.file(gotFile, fail);
    }

    function gotFile(file){
        readAsText(file);
    }

    function readAsText(file) {
				//alert("hello");
        var reader = new FileReader();
        reader.onloadend = function(evt) {
            //console.log("Read as text");
            //console.log(evt.target.result);
			var arg=evt.target.result.split(";");
			 if (arg==""){
                window.location.href ='login.html';
			 }else{
				 var arg1=arg[0].split("=");
				 var arg2=arg[1].split("=");
				 var uid1=arg1[1];
				 var access_token1=arg2[1];
				 var arg4=arg[4].split("=");
				 var expire=arg4[1];				 
				
				if(expire<now){
					window.location.href ='sinalogin.html';
				}else{
				
				var score = $('#star').raty('score');
				if (score== ""){
					score=0;
				}
				var con = document.getElementsByName('textarea');
				
//开始分享	
				$.ajax({type:'POST',async:false, url:'https://api.weibo.com/2/statuses/update.json',data:{access_token:access_token1,uid:uid1,client_id:"3943049038",status:"我在"+shopname+"，"+con[0].value+" ，评分："+star[score-1],lat:31.176173,long:121.127916}});
				//$.ajax({type:'POST', url:'https://graph.qq.com/t/add_t',data:{access_token:"40E4FBB667C41EBD4656236CB917EFC4",oauth_consumer_key:"100284268",openid:"D08D45C9F3E2F67A5B96EA312FFF61D8",content:"我正在某某地干嘛"+con[0].value+"  "+star[score-1]}});
				$.ajax({type:'POST',async:false, url:'http://ihavecar.sinaapp.com/postcomment.php?shopid='+shopid+'&type='+type+'&userid='+uid1+'&score='+score+'&content="'+con[0].value+'"'});

				window.location.href ='shopinfo.html?type='+type+'&shopid='+shopid;
			}
        };
        reader.readAsText(file);
    }

    function fail(evt) {
        console.log(evt.target.error.code);
		window.location.href ='login.html';
    }
	}
}

function checklogin() {
	document.addEventListener("deviceready", onDeviceReady, false);
    // PhoneGap is ready
    function onDeviceReady() {
        window.requestFileSystem(LocalFileSystem.PERSISTENT, 0, gotFS, fail);
    }

    function gotFS(fileSystem) {
        fileSystem.root.getFile("ucar/DataFile.txt", {create: true}, gotFileEntry, fail);
    }

    function gotFileEntry(fileEntry) {
        fileEntry.file(gotFile, fail);
    }

    function gotFile(file){
        readAsText(file);
    }

    function readAsText(file) {
		var reader = new FileReader();
        reader.onloadend = function(evt) {
            var arg=evt.target.result.split(";");
			

            if (arg==""){
                // Empty file. Not Logined.
                $("#sina").css("background-position", "0 -16px");
                alert("您仍未登录，请先登录，才可以进行点评与分享");
								window.location.href ='login.html';
            }
        };
        reader.readAsText(file);	
    }

    function fail(evt) {
    		$("#sina").css("background-position", "0 -16px");
				alert("您仍未登录，请先登录，才可以进行点评与分享");
				window.location.href ='login.html';
				console.log("Detect as NOT logined.");
        console.log(evt.target.error.code);
    }
}

</script>
</body>
</html>