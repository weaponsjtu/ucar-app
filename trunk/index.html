<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="initial-scale=1.0, user-scalable=no"/>
<meta http-equiv="content-type" content="text/html; charset=utf-8"/>
<link href="jquery-mobile/jquery.mobile-1.2.0-alpha.1.css" rel="stylesheet" type="text/css"/>
<script src="jquery-mobile/jquery-1.7.2.js" type="text/javascript"></script>
<script src="jquery-mobile/jquery.mobile-1.2.0-alpha.1.js" type="text/javascript"></script>

<script type="text/javascript" charset="utf-8" src="cordova.js"></script>
<script type="text/javascript" src="http://api.map.baidu.com/api?v=1.3"></script>
<script type="text/javascript" src="http://api.map.baidu.com/library/InfoBox/1.2/src/InfoBox_min.js"></script>
<script type="text/javascript" src="http://dev.baidu.com/wiki/static/map/API/examples/script/convertor.js"></script>
<script type="text/javascript" src="UcarV1.js"></script>

<script src="showRepair.js" type="text/javascript"></script>
<script src="showGasoline.js" type="text/javascript"></script>
<script type="text/javascript" src="getUrlParam.js"></script>




<script type="text/javascript" src="jquery.raty.js"></script>

<title>Ucar</title>

<script type="text/javascript">
function ucar(map, type, lng, lat) {
	//æ˜¾ç¤ºæœç´¢æ¡?
	$("#searchBox").css("display", "block");
	
	$("#container").css("height", document.body.clientHeight - $("#container").offset().top - $("#footer").height());
	
	map.clearOverlays();
	
	//æ˜¾ç¤ºå½“å‰ä½ç½®
	getGPS();
	
	if (lng != "" && lat != "") {
		var newpoint = new BMap.Point(lng.valueOf(),lat.valueOf());
		map.panTo(newpoint);
		
		/*var myIcon_Y = new BMap.Icon("img/pinY.png", new BMap.Size(61, 94));
		var searchMarker =new BMap.Marker(newpoint, {icon: myIcon_Y});
		map.addOverlay(searchMarker);
		var searchLabel = new BMap.Label("ç»åº¦: " + lng + ", çº¬åº¦: " + lat);
		searchLabel.setOffset(new BMap.Size(10,-10));
		searchMarker.setLabel(searchLabel);*/
	}
	
	
	if (type == 1) {
		//æ”¹å˜æ ‡é¢˜
		$("#title  .ui-btn-text").html("ä¿å…»ä¸ç»´ä¿?);
		//æ˜¾ç¤ºæ±½ä¿®åº?
		showRepairPlace(map);
	}  else if (type == 2) {
		//æ”¹å˜æ ‡é¢˜
		$("#title  .ui-btn-text").html("åŠ æ²¹ç«?);
		
		//æ˜¾ç¤ºåŠ æ²¹ç«?
		showGasolinePlace(map);
	} else {
		alert("Wrong type");
	}

	//var opts = {type:BMAP_NAVIGATION_CONTROL_ZOOM}
	//map.addControl(new BMap.NavigationControl(opts));
	map.addControl(new BMap.ScaleControl());
	
	//æ·»åŠ åˆ·æ–°æ§ä»¶
	function ZoomControl_TR(){
		this.defaultAnchor = BMAP_ANCHOR_TOP_RIGHT;
		this.defaultOffset = new BMap.Size(5,5);
	}
	ZoomControl_TR.prototype = new BMap.Control();
	ZoomControl_TR.prototype.initialize = function(map) {
		var div = document.createElement("div");
		div.innerHTML = "<img style='width: 45px; height: 44px;' src='img/loading.png'>";
		div.style.cursor = "pointer";
		div.onclick = function (e) {
			if (type == 1) {
				showRepairPlace(map);
			} else if (type == 2) {
				showGasolinePlace(map);
			} else {
				alert("Wrong type");
			}
		}
		map.getContainer().appendChild(div);
		return div;
	}
	var myZoomCtrl_TR = new ZoomControl_TR();
	map.addControl(myZoomCtrl_TR);
	
	//æ·»åŠ å®šä½æ§ä»¶
	function ZoomControl_BR(){
		this.defaultAnchor = BMAP_ANCHOR_BOTTOM_RIGHT;
		this.defaultOffset = new BMap.Size(5,5);
	}
	ZoomControl_BR.prototype = new BMap.Control();
	ZoomControl_BR.prototype.initialize = function(map) {
		var div = document.createElement("div");
		div.innerHTML = "<img style='width: 45px; height: 44px;' src='img/pin.png'>";
		div.style.cursor = "pointer";
		div.onclick = function (e) {
			getGPS();
			/*if (type == 1) {
				showRepairPlace(map);
			} else if (type == 2) {
				showGasolinePlace(map);
			} else {
				alert("Wrong type");
			}*/
		}
		map.getContainer().appendChild(div);
		return div;
	}
	var myZoomCtrl_BR = new ZoomControl_BR();
	map.addControl(myZoomCtrl_BR);
	
	//æ·»åŠ ç¼©æ”¾æ§ä»¶
	function ZoomControl_TL(){
		this.defaultAnchor = BMAP_ANCHOR_TOP_LEFT;
		this.defaultOffset = new BMap.Size(5,5);
	}
	ZoomControl_TL.prototype = new BMap.Control();
	ZoomControl_TL.prototype.initialize = function(map) {		
		div = document.createElement("div");
		div.innerHTML = "<img src='img/zoomOut.png' style='cursor: pointer; width: 32px; height: 30px;' onclick='map.zoomIn()'><br>" +
		"<img src='img/zoomIn.png' style='cursor: pointer; width: 32px; height: 30px;' onclick='map.zoomOut()'>";
		map.getContainer().appendChild(div);
		return div;
	}
	var myZoomCtrl_TL = new ZoomControl_TL();
	map.addControl(myZoomCtrl_TL);
	
}


function repair(map) {
	$("#suspendBox").popup("close");
	ucar(map, 1, "","");
}

function gasoline(map) {
	$("#suspendBox").popup("close");
	ucar(map, 2, "","");
}

function collect(){
	$("#suspendBox").popup("close");
	//è¯»å–ç™»å½•æ–‡ä»¶ï¼Œè‹¥è¯»å–æˆåŠŸåˆ™è®¤ä¸ºå·²ç™»å½•ï¼Œæ˜¾ç¤ºå·²ç™»å½•ä¿¡æ¯ï¼›åä¹‹æ˜¾ç¤ºç™»å½•æ¡†
function readfile() {
	document.addEventListener("deviceready", onDeviceReady, false);
    // PhoneGap is ready
    function onDeviceReady() {
        window.requestFileSystem(LocalFileSystem.PERSISTENT, 0, gotFS, fail);
    }

    function gotFS(fileSystem) {
        fileSystem.root.getFile("ucar/DataFile.txt", {create: true}, gotFileEntry, fail);
    }

    function gotFileEntry(fileEntry) {
        fileEntry.file(gotFile, fail);
    }

    function gotFile(file){
        readAsText(file);
    }

    function readAsText(file) {
				//alert("hello");
        var reader = new FileReader();
        reader.onloadend = function(evt) {
            //console.log("Read as text");
            //console.log(evt.target.result);
			var arg=evt.target.result.split(";");
			

            if (arg==""){
                // Empty file. Not Logined.
                $("#logbox").show();
            }else{
                //Read Loginfile
                var arg1=arg[0].split("=");
				var arg2=arg[1].split("=");
				var arg3=arg[2].split("=");
				var arg4=arg[3].split("=");
            
				var uid=arg1[1];
				
           	self.location = "collect.html?uid="+uid;            
			}
        };
        reader.readAsText(file);	
		
		
    }

    function fail(evt) {
		$("#logbox").show();
		console.log("Detect as NOT logined.");
        console.log(evt.target.error.code);
    }
}	
}

function settings(){
	$("#infobox").popup("close");
	self.location = "login.html";	
}

    
function init_index() {
     map = new BMap.Map("container",{enableHighResolution:true});
     $("#container").css("height", document.body.clientHeight - $("#container").offset().top - $("#footer").height());
     var type = request("type");
     if(type.indexOf("1") != -1){
         //æ”¹å˜æ ‡é¢˜
         $("#title  .ui-btn-text").html("ä¿å…»ä¸ç»´ä¿?);
     }
     if(type.indexOf("2") != -1){
         //æ”¹å˜æ ‡é¢˜
         $("#title  .ui-btn-text").html("åŠ æ²¹ç«?);
     }
     
function readfile() {
	document.addEventListener("deviceready", onDeviceReady, false);
    // PhoneGap is ready
    function onDeviceReady() {
        window.requestFileSystem(LocalFileSystem.PERSISTENT, 0, gotFS, fail);
    }

    function gotFS(fileSystem) {
        fileSystem.root.getFile("ucar/DataFile.txt", {create: true}, gotFileEntry, fail);
    }

    function gotFileEntry(fileEntry) {
        fileEntry.file(gotFile, fail);
    }

    function gotFile(file){
        readAsText(file);
    }

    function readAsText(file) {
				//alert("hello");
        var reader = new FileReader();
        reader.onloadend = function(evt) {
            //console.log("Read as text");
            //console.log(evt.target.result);
			var arg=evt.target.result.split(";");
			

            if (arg==""){
                // Empty file. Not Logined.
                
            }else{
                //Read Loginfile
                var arg1=arg[0].split("=");
				var arg2=arg[1].split("=");
				var arg3=arg[2].split("=");
				var arg4=arg[3].split("=");
            
				access_token=arg2[1];
				nickname=arg3[1];
				image=arg4[1];

            
         $("currentUser").html(image);
         $("nickname").html(nickname);
         //$("userStatus").html(status);
                
			}
        };
        reader.readAsText(file);	
		
		
    }

    function fail(evt) {
		$("#logbox").show();
		console.log("Detect as NOT logined.");
        console.log(evt.target.error.code);
    }
}

     getGPS();
}
     
    
    
$(window).load(function() {
	var lng = request("lng");
	var lat = request("lat");
	
	var type = request("type");
	
	if(type.indexOf("1") != -1){
		ucar(map, 1, lng, lat);
	}
	if(type.indexOf("2") != -1){
		ucar(map, 2, lng, lat);
	} 
});

//è‡ªåŠ¨è”æƒ³
var ac = new BMap.Autocomplete(    //å»ºç«‹ä¸€ä¸ªè‡ªåŠ¨å®Œæˆçš„å¯¹è±¡
    {"input" : "search"
    ,"location" : "ä¸Šæµ·"
});

var searchValue;
ac.addEventListener("onconfirm", function(e) {    //é¼ æ ‡ç‚¹å‡»ä¸‹æ‹‰åˆ—è¡¨åçš„äº‹ä»¶
	  var _value = e.item.value;
    searchValue = _value.province +  _value.city +  _value.district +  _value.street + _value.business;
    if (_value.province !="ä¸Šæµ·å¸? && _value.city!="ä¸Šæµ·å¸? && _value.province!="")
        alert("è¶…å‡ºä¸Šæµ·");  
    if ($("#title  .ui-btn-text").html() == "ä¿å…»ä¸ç»´ä¿?) {              
      SearchRepairPlace(map,searchValue);
    } else {
    	SearchGasolinePlace(map,searchValue);
    }
    $("#search").blur();
});

if(DEBUG || true) {
	$(document).ready(function(){
	  init_index();	
  });
} else {
  document.addEventListener("deviceready", onDeviceReady, false);
  function onDeviceReady()
  {
    init_index();
  }
}

    
    function checkConnection()
    {
        var networkState = navigator.network.connection.type;
        if (networkState == Connection.NONE)
            alert ("æ²¡æœ‰è”ç½‘");
         else
            alert ("è”ç½‘äº?); 
    }
    
</script>

<style type="text/css">
.box {
	background-color: #222;
	/*opacity: 0.95;*/
	border-radius: 15px;
	border-style: solid;
	border-color: white;
	border-width: 1px;
}

.left {
	float: left;
	padding: 10px;
}

.clear {
	clear: both;
}

.label {
	color: white;
	font-size: 12px;
	padding: 2px;
	font-family:"Courier New", Courier, monospace;
}

.center {
	text-align:center;
}

div#suspendBox .icon {
	height: 114px;
	width: 114px;
}

#title {
	font-size: 20px;
}

div#shopbox .label {
	font-weight: bold;
	font-size: 14px;
}

/*ä¿¡æ¯æ¡?/
div#shopbox {
	background: url("img/infobox.png") no-repeat;
	width: 220px;
	height: 59px;
	padding-left: 5px;
}

td#wrap {
	width: 190px;
}

img#logo {
	 position: absolute;
	 width: 50px;
	 height: 42px;
	 margin-top: 4px;
	 margin-left: 5px;
}
/*
div#header {
	 height: 50px;
}*/
</style>

</head>
	
<body >

<div data-role="page" id="main_menu">
    <div data-role="header" id="header" data-theme="b">
    	  <img src="img/LOGO.png" id="logo">
        <h1>
        	  
        	  <a href="#suspendBox"  data-rel="popup" data-role="button" data-position-to="window" id="title" data-transition="slidedown">é¦–é¡µ</a>
        </h1>
		
		
		<div id="suspendBox" data-role="popup" data-theme="none" class="ui-content box">
         <div>
           <div id='repair' class='left' onclick='repair(map)'><img src='img/repair.png' class='icon'><div class='label center'>ä¿å…»ç»´ä¿®</div></div>
           <div id='gasoline' class='left' onclick='gasoline(map)'><img src='img/gasoline.png' class='icon' ><div class='label center'>åŠ æ²¹ç«?/div></div>
	         <div id='park' class='left'><img src='img/park.png' class='icon'><div class='label center'>åœè½¦åœ?/div></div>
	         <div id='collect' class='left' onclick='collect()'><img src='img/collect.png' class='icon'><div class='label center'>æˆ‘çš„æ”¶è—</div></div>
	         <div id='setting' class='left' onclick='settings()'><img src='img/settings.png' class='icon'><div class='label center'>è®¾ç½®</div></div>
	         <div class='clear'></div>
         </div>
         <div style="float: right">
             <div style="float: right"><img id="currentUser" src='img/unlogin.png' class='icon'></div>
             <div style="float: right; margin-top: 20px; margin-right: 10px;">
               <div class='label' style="font-size: 16px;"><b id="nickname">æœªç™»å½?/b></div>
               <div class='label' style="font-size: 10px;" id="userStatus">ç‚¹å‡»ç™»å½•</div>
             </div>
         </div>
         <div class='clear'></div>
		</div>
	</div>
    
        <div id="searchBox" style="display:none">
    	  <input type="search" data-mini="true" placeholder="è¾“å…¥åœ°å€" id="search"  onKeyDown="enterSearch(map)"></input>
        </div>
        <div id="container">
         
        </div>
        
     <div data-role="footer" id="footer">
     	<h5>
        <font style="color: white;">å½“å‰ä½ç½®:&nbsp;&nbsp;<b id="current"></b></font>
        </h5>
     </div>
    
</div>

</body>
</html>
