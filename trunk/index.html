<!DOCTYPE html>
<html>
<head>
<meta name="viewpoint" content="initial-scale=1.0, user-scalable=no"/>
<meta http-equiv="content-type" content="text/html; charset=utf-8"/>
<link href="jquery-mobile/jquery.mobile-1.2.0-alpha.1.css" rel="stylesheet" type="text/css"/>
<script src="jquery-mobile/jquery-1.7.2.js" type="text/javascript"></script>
<script src="jquery-mobile/jquery.mobile-1.2.0-alpha.1.js" type="text/javascript"></script>

<script type="text/javascript" charset="utf-8" src="cordova.js"></script>
<script type="text/javascript" src="http://api.map.baidu.com/api?v=1.3"></script>
<script type="text/javascript" src="http://api.map.baidu.com/library/InfoBox/1.2/src/InfoBox_min.js"></script>
<script type="text/javascript" src="http://dev.baidu.com/wiki/static/map/API/examples/script/convertor.js"></script>

<script src="showRepair.js" type="text/javascript"></script>
<script src="showGasoline.js" type="text/javascript"></script>
<script type="text/javascript" src="getUrlParam.js"></script>



<script type="text/javascript" src="jquery.raty.js"></script>

<title>Ucar</title>

<script type="text/javascript">



function getGPS()
{
	var gps = navigator.geolocation;
	if (gps)
	{
		gps.getCurrentPosition(showgps,
		function (error)
		{
			alert('got an error: ' + error.code + 'message: ' + error.message);
		},
		{timeout:20000,enableHighAccuracy: true});
	}
	else
	{
		showgps();
	}
}


/*
//移动版

function showgps(position)
{
	if (position)
	{
		var latitude = position.coords.latitude;
		var longitude = position.coords.longitude;
		var gpspoint = new BMap.Point(longitude,latitude);
		BMap.Convertor.translate(gpspoint,0,translateCallback);

	}
	else
		alert('position is null');
	
}
*/
	

//模拟器测试版
function showgps(position)
{
		var gpspoint = new BMap.Point(121.42559,31.01726);
		BMap.Convertor.translate(gpspoint,0,translateCallback);
}


function translateCallback (point) {
	map.centerAndZoom(point, 15);
	
	//给地图添加监听器，移除信息框
	map.addEventListener("click", function(event){
		if (event.overlay instanceof BMap.Marker) {
			
		} else {
			overlays = map.getOverlays();
			for (var i = 0; i < overlays.length; i++) {
				if (overlays[i] instanceof BMapLib.InfoBox) {
					overlays[i].close();
				}
				if (overlays[i] instanceof BMap.Marker) {
					var myIcon_Y = new BMap.Icon("img/pinY.png", new BMap.Size(25, 34), {
     		  			anchor: new BMap.Size(12, 34),
					});
					overlays[i].setIcon(myIcon_Y);
				}
			}
		}
	});
	
	var myGeo = new BMap.Geocoder();  
	// 根据坐标得到地址描述  
	myGeo.getLocation(point, function(result){  
	 if (result){  
	   $("#current").html(result.address);  
	 }  
	});
	
	map.enablePinchToZoom();
	
	showYourPosition(map,point);
}

function showYourPosition(map,point)
{
	var myIcon = new BMap.Icon("img/position.png", new BMap.Size(32, 32), {
         anchor: new BMap.Size(12, 34),
	});
	var marker =new BMap.Marker(point, {icon: myIcon});
	map.addOverlay(marker);
}

function ucar(map, type, lng, lat) {
	//显示搜索框
	$("#searchBox").css("display", "block");
	
	$("#container").css("height", document.body.clientHeight - $("#container").offset().top - $("#footer").height());
	
	map.clearOverlays();
	
	//显示当前位置
	showgps();
	
	if (lng != "" && lat != "") {
		var newpoint = new BMap.Point(lng.valueOf(),lat.valueOf());
		map.centerAndZoom(newpoint, 15);
		
		var myIcon_Y = new BMap.Icon("img/pinY.png", new BMap.Size(25, 34), {
     		  anchor: new BMap.Size(12, 34),
		});
		var searchMarker =new BMap.Marker(newpoint, {icon: myIcon_Y});
		map.addOverlay(searchMarker);
		var searchLabel = new BMap.Label("经度: " + lng + ", 纬度: " + lat);
		searchLabel.setOffset(new BMap.Size(10,-10));
		searchMarker.setLabel(searchLabel);
	}
	
	
	if (type == 1) {
		//改变标题
		$("#title  .ui-btn-text").html("保养与维修");
		
		//显示汽修店
		showRepairPlace(map);
	} 
	else if (type == 2) {
		//改变标题
		$("#title  .ui-btn-text").html("加油站");
		
		//显示加油站
		showGasolinePlace(map);
	} else {
		alert("Wrong type");
	}
	
	var opts = {type:BMAP_NAVIGATION_CONTROL_ZOOM}
	map.addControl(new BMap.NavigationControl(opts));
	map.addControl(new BMap.ScaleControl());
	
	//添加刷新控件
	function ZoomControl_TR(){
		this.defaultAnchor = BMAP_ANCHOR_TOP_RIGHT;
		this.defaultOffset = new BMap.Size(10,10);
	}
	ZoomControl_TR.prototype = new BMap.Control();
	ZoomControl_TR.prototype.initialize = function(map) {
		var div = document.createElement("div");
		div.innerHTML = "<img src='img/loading.jpg'>";
		div.style.cursor = "pointer";
		div.onclick = function (e) {
			if (type == 1) {
				showRepairPlace(map);
			} else if (type == 2) {
				showGasolinePlace(map);
			} else {
				alert("Wrong type");
			}
		}
		map.getContainer().appendChild(div);
		return div;
	}
	var myZoomCtrl_TR = new ZoomControl_TR();
	map.addControl(myZoomCtrl_TR);
	
	//添加定位控件
	function ZoomControl_BR(){
		this.defaultAnchor = BMAP_ANCHOR_BOTTOM_RIGHT;
		this.defaultOffset = new BMap.Size(10,10);
	}
	ZoomControl_BR.prototype = new BMap.Control();
	ZoomControl_BR.prototype.initialize = function(map) {
		var div = document.createElement("div");
		div.innerHTML = "<img class='icon' src='img/pin.png'>";
		div.style.cursor = "pointer";
		div.onclick = function (e) {
			showgps();
			if (type == 1) {
				showRepairPlace(map);
			} else if (type == 2) {
				showGasolinePlace(map);
			} else {
				alert("Wrong type");
			}
		}
		map.getContainer().appendChild(div);
		return div;
	}
	var myZoomCtrl_BR = new ZoomControl_BR();
	map.addControl(myZoomCtrl_BR);
}


function repair(map) {
	$("#infobox").popup("close");
	ucar(map, 1, "","");
}

function gasoline(map) {
	$("#infobox").popup("close");
	ucar(map, 2, "","");
}

function collect(){
	$("#infobox").popup("close");
	self.location = "collect.html";	
}

function settings(){
	$("#infobox").popup("close");
	self.location = "login.html";	
}

$(document).ready(function() {
//$(document).bind("pageinit", function(){
	map = new BMap.Map("container");
	$("#container").css("height", document.body.clientHeight - $("#container").offset().top - $("#footer").height());
	var type = request("type");
	if(type == ""){
		//$("#infobox").popup("open");
	}
    showgps();
	console.log("document ready");
});

$(window).load(function() {
	console.log("window load");
	var lng = request("lng");
	var lat = request("lat");
	
	var type = request("type");
	if(type.indexOf("1") != -1){
		ucar(map, 1, lng, lat);
	}
	if(type.indexOf("2") != -1){
		ucar(map, 2, lng, lat);
	} 
});

//自动联想
var ac = new BMap.Autocomplete(    //建立一个自动完成的对象
    {"input" : "search"
    ,"location" : "上海"
});

var searchValue;
ac.addEventListener("onconfirm", function(e) {    //鼠标点击下拉列表后的事件
	var _value = e.item.value;
    searchValue = _value.province +  _value.city +  _value.district +  _value.street + _value.business;
    SearchRepairPlace(map,searchValue);
	$("#search").blur();
});


</script>

<style type="text/css">
.box {
	background-color: #222;
	opacity: 0.95;
	border-radius: 15px;
	border-style: solid;
	border-color: white;
	border-width: 1px;
}

.left {
	float: left;
	padding: 10px;
}

.clear {
	clear: both;
}

.label {
	color: white;
	font-size: 12px;
	padding: 2px;
	font-family:"Courier New", Courier, monospace;
}

.center {
	text-align:center;
}

.icon {
	width: 65px;
	height: 65px;
}

#title {
	font-size: 20px;
}

table td {
	padding: 0 5px;
}
</style>

</head>
	
<body >

<div data-role="page" id="main_menu">
    <div data-role="header" id="header" data-theme="b">
        <a href="#" onclick="self.location='index.html'" data-role="content"><img src="img/LOGO.png" style="width: 60px; height:50px;"></a>
        <h1><a href="#infobox"  data-rel="popup" data-role="button" data-icon="search" data-iconpos="right" data-position-to="#container" id="title" data-transition="slidedown">首页</a></h1>
		<div id="infobox" data-role="popup" data-theme="none" class="ui-content box">
          <div>
           <div id='repair' class='left' onclick='repair(map)'><img src='img/repair.png' class='icon'><div class='label center'>保养与维修</div></div>
           <div id='gasoline' class='left' onclick='gasoline(map)'><img src='img/gasoline.png' class='icon' ><div class='label center'>加油站</div></div>
	       <div id='park' class='left'><img src='img/park.png' class='icon'><div class='label center'>停车场</div></div>
	       <div id='collect' class='left' onclick='collect()'><img src='img/collect.png' class='icon'><div class='label center'>我的收藏</div></div>
	       <div id='setting' class='left' onclick='settings()'><img src='img/settings.png' class='icon'><div class='label center'>设置</div></div>
	       <div class='clear'></div>
          </div>
          <div style="float: right">
             <div style="float: right"><img src='img/unlogin.png' class='icon'></div>
             <div style="float: right;">
               <div class='label' style="font-size: 16px;">未登录</div>
               <div class='label'>点击登录</div>
             </div>
          </div>
          <div class='clear'></div>
		</div>
	</div>
    
        <div id="searchBox" style="display:none">
    	  <input type="search" data-mini="true" placeholder="输入地址" id="search"  onKeyDown="enterSearch(map)"></input>
        </div>
        <div id="container">
         
        </div>
        
     <div data-role="footer" id="footer">
     	<h3>
        <font style="color: white;">当前位置:&nbsp;&nbsp;<b id="current"></b></font>
        </h3>
     </div>
    
</div>


<script type="text/javascript">
   console.log("document load");
</script>

</body>
</html>
